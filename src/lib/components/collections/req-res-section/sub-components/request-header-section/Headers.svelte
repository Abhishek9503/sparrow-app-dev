<script lang="ts">
  import { sortable } from "svelte-agnostic-draggable";
  import AutoGeneratedHeaders from "./AutoGeneratedHeaders.svelte";
  import {
    collapsibleState,
    handleRequestChange,
  } from "$lib/store/request-response-section";
  import type { NewTab } from "$lib/utils/interfaces/request.interface";
  import KeyValue from "$lib/components/key-value/KeyValue.svelte";
  import { createDeepCopy } from "$lib/utils/helpers/conversion.helper";
  import { AuthSection, AuthType } from "$lib/utils/enums/authorization.enum";
  import { onMount } from "svelte";

  export let currentTabId: string;
  export let requestData: NewTab;
  let authValue = {
    key: "",
    value: "",
  };
  let isClicked: boolean = false;

  const handleHeader = () => {
    isClicked = !isClicked;
  };

  let isCollaps: boolean;
  collapsibleState.subscribe((value) => {
    isCollaps = value;
  });

  const handleHeaderChange = (pairs) => {
    handleRequestChange(pairs, "headers", currentTabId);
  };
  const handleAutoGeneratedChange = (pairs) => {
    handleRequestChange(pairs, "autoGeneratedHeaders", currentTabId)
  };

  const findAuthHeader = () => {
    if (
      requestData.request.state.auth === AuthType.BEARER_TOKEN &&
      requestData.request.auth.bearerToken
    ) {
      authValue.key = "Authorization";
      authValue.value = "Bearer " + requestData.request.auth.bearerToken;
    } else if (requestData.request.state.auth === AuthType.BASIC_AUTH) {
      authValue.key = "Authorization";
      authValue.value = `Basic Og== ${requestData.request.auth.basicAuth.username} ${requestData.request.auth.basicAuth.password}`;
    } else if (
      requestData.request.state.auth === AuthType.API_KEY &&
      requestData.request.auth.apiKey.addTo === AuthSection.HEADER &&
      requestData.request.auth.apiKey.authKey &&
      requestData.request.auth.apiKey.authValue
    ) {
      authValue.key = requestData.request.auth.apiKey.authKey;
      authValue.value = requestData.request.auth.apiKey.authValue;
    } else {
      authValue.key = "";
      authValue.value = "";
    }
  };

  $: {
    if (requestData) {
      findAuthHeader();
    }
  }

  $: {
    if (currentTabId) {
      findAuthHeader();
    }
  }

  onMount(() => {
    findAuthHeader();
  });
</script>

<!-- <section class="w-100">
  {#if isClicked}
    <AutoGeneratedHeaders />
  {/if}

  <div class="py-3 ps-2">
    <button
      on:click|preventDefault={handleHeader}
      class="d-flex bg-backgroundColor border-0 gap-2 text-labelColor"
      style="font-size: 12px;"
    >
      {#if isClicked}
        <p>Hide auto-generated headers</p>
        <div>
          <img src={""} alt="" />
        </div>
      {:else}
        <p>Show auto-generated headers</p>
        <div>
          <img src={""} alt="" />
        </div>
      {/if}
    </button>
  </div>
</section> -->

<section class="w-100">
  <KeyValue
    mode={"READ"}
    readable={authValue}
    keyValue={createDeepCopy(requestData.request.autoGeneratedHeaders)}
    callback={handleAutoGeneratedChange}
  />
  <KeyValue
    keyValue={createDeepCopy(requestData.request.headers)}
    callback={handleHeaderChange}
  />
</section>

<style>
</style>

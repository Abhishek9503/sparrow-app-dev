<script context="module">
  import { enableBodyScroll, disableBodyScroll } from "body-scroll-lock";
  import dragIcon from "$lib/assets/drag.svg";
  import trashIcon from "$lib/assets/trash-icon.svg";

  import angleDown from "$lib/assets/angle-down2.svg";
  import angleUp from "$lib/assets/angle-up.svg";
</script>

<script lang="ts">
  import { sortable } from "svelte-agnostic-draggable";
  import AutoGeneratedHeaders from "./AutoGeneratedHeaders.svelte";
  import { collapsibleState } from "$lib/store/request-response-section";

  /**** Svelte Event Handling ****/

  function onSortableInit() {
    // console.log("Sortable was created");
  }

  function onSortableActivate() {
    // console.log("Sortable was activated");
    disableBodyScroll(document.body);
  }

  function onSortStart() {
    // console.log("sorting started");
  }

  function onSortMove() {
    // console.log("sorting continues");
  }

  function onSortStop() {
    // console.log("sorting stopped");
  }

  function onSortableOver() {
    // console.log("Draggable entered Sortable");
  }

  function onSortableChange() {
    // console.log("sort order was changed");
  }

  function onSortableRemove() {
    // console.log("list element was removed");
  }

  function onSortableReceive() {
    // console.log("list element was added");
  }

  function onSortableUpdate() {
    // console.log("list items were updated");
  }

  function onSortableOut() {
    // console.log("Draggable left Sortable");
  }

  function onSortableDeactivate() {
    // console.log("Sortable was deactivated");
    enableBodyScroll(document.body);
  }

  function onSortableDestroy() {
    // console.log("Sortable was destroyed");
  }

  /**** List Data ****/

  let isHovered = false;
  let rows = [{ key: "", value: "" }];

  function toggleHover() {
    isHovered = !isHovered;
  }

  function addRow() {
    if (rows.length === 1 && rows[0].key === "" && rows[0].value === "") {
      rows[0].key = "New Key";
      rows[0].value = "New Value";
    } else if (
      rows[rows.length - 1].key !== "" ||
      rows[rows.length - 1].value !== ""
    ) {
      rows = [...rows, { key: "", value: "" }];
    }
  }

  let isClicked = false;

  const handleHeader = () => {
    isClicked = !isClicked;
  };

  let isCollaps: any;
  collapsibleState.subscribe((value) => {
    isCollaps = value;
  });
</script>

<div class="header d-flex flex-column mt-3 w-100">
  <div
    class="d-flex ps-2 ms-5 text-requestBodyColor align-items-center justify-content-between"
    style="font-size: 12px; font-weight: 500;"
  >
    <p>Key</p>
    <p style="margin-right: 190px;">Value</p>
  </div>
  {#if isClicked}
    <AutoGeneratedHeaders />
  {/if}
  <div
    class="sortable"
    use:sortable={{
      cursor: "grabbing",
      zIndex: 10,
    }}
    style="position: relative;align-items:center;justify-content:center;margin-bottom: 1px;
    "
    on:sortable:init={onSortableInit}
    on:sortable:destroy={onSortableActivate}
    on:sortable:activate={onSortableActivate}
    on:sortable:deactivate={onSortableDeactivate}
    on:sort:start={onSortStart}
    on:sort:move={onSortMove}
    on:sort:stop={onSortStop}
    on:sortable:over={onSortableOver}
    on:sortable:out={onSortableOut}
    on:sortable:change={onSortableChange}
    on:sortable:update={onSortableUpdate}
    on:sortable:remove={onSortableRemove}
    on:sortable:receive={onSortableReceive}
  >
    {#each rows as row, index}
      <div
        role="button"
        aria-label="Toggle Hover"
        class="sortable > div"
        style="overflow-y:auto;overflow-x:hidden;"
      >
        <div
          on:mouseenter={toggleHover}
          on:mouseleave={toggleHover}
          style="
          width:{isCollaps ? '100%' : '100%'};
            overflow-y:auto;overflow-x:hidden;
            margin: 0px;
            padding-top: 3px;
            cursor: grab;
            background-color:backgroundColor;
            cursor: grabbing;
            display: flex;
          
          "
        >
          <div
            class="d-flex align-items-center justify-content-center gap-2 mb-2"
          >
            <img src={dragIcon} alt="" style="cursor: grabbing;" />

            <div>
              <input
                class="form-check-input"
                type="checkbox"
                on:mouseenter={toggleHover}
                on:mouseleave={toggleHover}
              />
            </div>
            <div class="flex-grow w-100">
              <input
                on:mouseenter={toggleHover}
                on:mouseleave={toggleHover}
                type="text"
                placeholder="Enter Key"
                style="outline: none;font-size:13px;"
                class="form-control input-search input-lg bg-blackColor border-0 ps-2 py-1 pe-3"
                bind:value={row.key}
                on:input={addRow}
              />
            </div>
            <div class="flex-grow w-100">
              <input
                on:mouseenter={toggleHover}
                on:mouseleave={toggleHover}
                type="text"
                placeholder="Enter Value"
                style="outline: none;font-size:13px;"
                class="form-control input-search input-lg bg-blackColor inputField border-0 ps-2 py-1 pe-3"
                bind:value={row.value}
                on:input={addRow}
              />
            </div>

            <div class="w-75 h-75">
              <button class="bg-backgroundColor border-0">
                <img src={trashIcon} alt="" />
              </button>
            </div>
          </div>
        </div>
      </div>
    {/each}
  </div>

  <div class="py-3 ps-2">
    <button
      on:click|preventDefault={handleHeader}
      class="d-flex bg-backgroundColor border-0 gap-2 text-labelColor"
      style="font-size: 12px;"
    >
      {#if isClicked}
        <p>Hide auto-generated headers</p>
        <div>
          <img src={angleUp} alt="" />
        </div>
      {:else}
        <p>Show auto-generated headers</p>
        <div>
          <img src={angleDown} alt="" />
        </div>
      {/if}
    </button>
  </div>
</div>

<style>
  .header {
    height: auto;
  }

  .sortable > div {
    -webkit-touch-callout: none;
    -ms-touch-action: none;
    touch-action: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .inputField {
    border: none;
  }

  .inputField:hover {
    border-bottom: 1px solid red; /* Change border color as needed */
  }
</style>

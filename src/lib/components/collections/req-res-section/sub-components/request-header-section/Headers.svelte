<script lang="ts">
  import {
    collapsibleState,
    handleRequestChange,
  } from "$lib/store/request-response-section";
  import type { NewTab } from "$lib/utils/interfaces/request.interface";
  import KeyValue from "$lib/components/key-value/KeyValue.svelte";
  import { createDeepCopy } from "$lib/utils/helpers/conversion.helper";
  import { AuthSection, AuthType } from "$lib/utils/enums/authorization.enum";
  import angleUp from "$lib/assets/angle-up.svg";
  import angleDown from "$lib/assets/angle-down2.svg";
  import { onMount } from "svelte";

  export let currentTabId: string;
  export let requestData: NewTab;
  let authValue = {
    key: "",
    value: "",
  };
  let showGeneratedHeader: boolean = false;

  let isCollaps: boolean;
  collapsibleState.subscribe((value) => {
    isCollaps = value;
  });

  const handleHeaderChange = (pairs) => {
    handleRequestChange(pairs, "headers", currentTabId);
  };
  const handleAutoGeneratedChange = (pairs) => {
    handleRequestChange(pairs, "autoGeneratedHeaders", currentTabId);
  };

  const findAuthHeader = () => {
    if (
      requestData.request.state.auth === AuthType.BEARER_TOKEN &&
      requestData.request.auth.bearerToken
    ) {
      authValue.key = "Authorization";
      authValue.value = "Bearer " + requestData.request.auth.bearerToken;
    } else if (requestData.request.state.auth === AuthType.BASIC_AUTH) {
      authValue.key = "Authorization";
      authValue.value = `Basic Og== ${requestData.request.auth.basicAuth.username} ${requestData.request.auth.basicAuth.password}`;
    } else if (
      requestData.request.state.auth === AuthType.API_KEY &&
      requestData.request.auth.apiKey.addTo === AuthSection.HEADER &&
      requestData.request.auth.apiKey.authKey &&
      requestData.request.auth.apiKey.authValue
    ) {
      authValue.key = requestData.request.auth.apiKey.authKey;
      authValue.value = requestData.request.auth.apiKey.authValue;
    } else {
      authValue.key = "";
      authValue.value = "";
    }
  };

  $: {
    if (requestData) {
      findAuthHeader();
    }
  }

  $: {
    if (currentTabId) {
      findAuthHeader();
    }
  }

  onMount(() => {
    findAuthHeader();
  });
</script>

<!-- <section class="w-100">
  {#if isClicked}
    <AutoGeneratedHeaders />
  {/if}

  <div class="py-3 ps-2">
    <button
      on:click|preventDefault={handleHeader}
      class="d-flex bg-backgroundColor border-0 gap-2 text-labelColor"
      style="font-size: 12px;"
    >
      {#if isClicked}
        <p>Hide auto-generated headers</p>
        <div>
          <img src={""} alt="" />
        </div>
      {:else}
        <p>Show auto-generated headers</p>
        <div>
          <img src={""} alt="" />
        </div>
      {/if}
    </button>
  </div>
</section> -->

<section class="w-100">
  {#if showGeneratedHeader}
    <KeyValue
      mode={"READ"}
      readable={authValue}
      keyValue={createDeepCopy(requestData.request.autoGeneratedHeaders)}
      callback={handleAutoGeneratedChange}
    />
    <div>
      <small on:click={()=>{
        showGeneratedHeader = false;
      }} class="text-labelColor generated-para">Hide auto-generated headers<img src={angleUp} alt="angleUp"></small>
    </div>
    <hr class="mt-1"/>
  {/if}
  <KeyValue
    keyValue={createDeepCopy(requestData.request.headers)}
    callback={handleHeaderChange}
  />
  {#if !showGeneratedHeader}
    <div>
      <small on:click={()=>{
        showGeneratedHeader = true;
      }} class="text-labelColor generated-para">Show auto-generated headers <img src={angleDown} alt="angleDown"></small>
    </div>
  {/if}
</section>

<style>
  .generated-para {
    font-size: 12px;
    cursor: pointer;
  }
</style>

<script lang="ts">
  import Loader from "@library/ui/loader/Loader.svelte";
  import ModalWrapperV1 from "@library/ui/modal/Modal.svelte";
  import { Splitpanes, Pane } from "svelte-splitpanes";

  import type { CollectionDocument } from "@app/database/database";
  import type { Observable } from "rxjs";
  import { SaveAsRequest } from "@workspaces/features";
  import type {
    CreateCollectionType,
    CreateFolderType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestMethodType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@workspaces/common/type";
  import {
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
    type RequestTab,
  } from "@common/types/workspace";
  import { webSocketSplitterDirection } from "../store";
  import Popover from "@library/ui/popover/Popover.svelte";
  import { onMount } from "svelte";
  import { Carousel, Modal } from "@library/ui";
  import {
    AdvanceAPI,
    CreateCollection,
    SendingApiRequest,
  } from "@workspaces/common/constants";
  import {
    HttpUrlSection,
    ResponseDefaultScreen,
    SocketHeaders,
    SocketNavigator,
    SocketParameters,
  } from "../components";
  import type { WebSocketTab } from "@common/types/workspace/web-socket";

  export let tab: Observable<WebSocketTab>;
  export let collections: Observable<CollectionDocument[]>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestParams: UpdateParamsType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onSaveRequest: SaveRequestType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let isGuestUser = false;
  /**
   * Role of user in active workspace
   */
  export let userRole;
  export let onRenameCollection;
  export let onRenameFolder;

  let isExposeSaveAsRequest = false;
  let isLoading = false;
  //   $: {
  //     if ($tab?.property?.request?.url?.length > 0) {
  //       isLoading = false;
  //     }
  //   }
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };
  let isGuidePopup = false;
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout h-100">
    <div class="w-100 d-flex flex-column h-100 px-3 pt-3 pb-2">
      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        isSave={$tab.isSaved}
        bind:userRole
        requestUrl={$tab.property.websocket.url}
        isSendRequestInProgress={$tab.property.websocket?.state
          ?.isSendRequestInProgress}
        onSendButtonClicked={onSendRequest}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {toggleSaveRequest}
        {onSaveRequest}
        {isGuestUser}
      />

      <div class="pt-2"></div>
      <div style="flex:1; overflow:auto;">
        {#if !isLoading}
          <Splitpanes
            class="rest-splitter w-100 h-100"
            id={"rest-splitter"}
            horizontal={$webSocketSplitterDirection === "horizontal"
              ? true
              : false}
            dblClickSplitter={false}
            on:resize={(e) => {
              onUpdateRequestState({
                socketLeftSplitterWidthPercentage: e.detail[0].size,
              });
              onUpdateRequestState({
                socketRightSplitterWidthPercentage: e.detail[1].size,
              });
            }}
          >
            <Pane
              minSize={30}
              size={$tab.property.websocket?.state
                ?.socketLeftSplitterWidthPercentage}
              class="position-relative bg-secondary-850-important"
            >
              <!-- Request Pane -->
              <div
                class="h-100 d-flex flex-column position-relative {$webSocketSplitterDirection ===
                'horizontal'
                  ? 'pb-1'
                  : 'pe-2'}"
              >
                <SocketNavigator
                  requestStateSection={$tab.property.websocket?.state
                    ?.socketNavigation}
                  {onUpdateRequestState}
                  authParameterLength={0}
                  authHeaderLength={0}
                  paramsLength={$tab.property?.websocket?.queryParams?.length ||
                    0}
                  headersLength={$tab.property?.websocket?.headers?.length || 0}
                  autoGeneratedHeadersLength={$tab.property?.websocket
                    ?.autoGeneratedHeaders?.length || 0}
                />
                <div style="flex:1; overflow:auto;" class="p-0">
                  {#if $tab.property.websocket?.state?.socketNavigation === RequestSectionEnum.PARAMETERS}
                    <SocketParameters
                      isBulkEditActive={$tab?.property?.websocket.state
                        ?.isParameterBulkEditActive}
                      {onUpdateRequestState}
                      params={$tab.property.websocket.queryParams}
                      {onUpdateRequestParams}
                      {onUpdateEnvironment}
                      {environmentVariables}
                    />
                  {:else if $tab.property.websocket?.state?.socketNavigation === RequestSectionEnum.HEADERS}
                    <SocketHeaders
                      isBulkEditActive={$tab?.property?.websocket.state
                        ?.isHeaderBulkEditActive}
                      {onUpdateRequestState}
                      {environmentVariables}
                      {onUpdateEnvironment}
                      headers={$tab.property.websocket.headers}
                      autoGeneratedHeaders={$tab.property.websocket
                        .autoGeneratedHeaders}
                      onHeadersChange={onUpdateHeaders}
                      onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
                    />
                  {/if}
                </div>
              </div>
            </Pane>
            <Pane
              minSize={30}
              size={$tab.property.websocket?.state
                ?.socketRightSplitterWidthPercentage}
              class="bg-secondary-850-important position-relative"
            >
              <!-- Response Pane -->
              <div
                class="d-flex flex-column h-100 {$webSocketSplitterDirection ===
                'horizontal'
                  ? 'pt-1'
                  : 'ps-2'}"
                style="overflow:auto;"
              >
                <div class="h-100 d-flex flex-column">
                  <div style="flex:1; overflow:auto;">
                    {#if $tab.property.websocket?.state?.isSendRequestInProgress}
                      <ResponseDefaultScreen />
                      <div
                        style="top: 0px; left: 0; right: 0; bottom: 0; z-index:3; position:absolute;"
                      >
                        <Loader loaderSize={"20px"} />
                      </div>
                    {:else}
                      <ResponseDefaultScreen />
                    {/if}
                  </div>
                </div>
              </div></Pane
            >
          </Splitpanes>
        {:else}
          <!-- loading state -->
          <ResponseDefaultScreen isMainScreen={true} />
        {/if}
      </div>
    </div>
  </div>
  <ModalWrapperV1
    title={"Save Request"}
    type={"dark"}
    width={"55%"}
    zIndex={10000}
    isOpen={isExposeSaveAsRequest}
    handleModalState={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
  >
    <SaveAsRequest
      onClick={(flag = false) => {
        isExposeSaveAsRequest = flag;
      }}
      requestMethod={"GET"}
      requestUrl={$tab.property.websocket?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {readWorkspace}
      {onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
      {onRenameCollection}
      {onRenameFolder}
    />
  </ModalWrapperV1>
{/if}

<Modal
  title={""}
  type={"dark"}
  width={"474px"}
  zIndex={10000}
  isOpen={isGuidePopup}
  handleModalState={(flag = false) => {
    isGuidePopup = flag;
  }}
>
  <div style="position: relative;">
    <Carousel
      handleClosePopup={(flag = false) => {
        isGuidePopup = flag;
      }}
      data={[
        {
          id: 1,
          heading: "Creating a Collection: Import existing or Start a new one",
          subheading: `Organize your APIs efficiently within "Collections" for streamlined API management and testing. Click the + Add Collection button in the side panel to create a collection. Choose 'Import Collection' to bring in existing API collections or create an empty Collection. `,
          gif: `${CreateCollection}`,
        },
        {
          id: 2,
          heading: "Sending an API Request",
          subheading:
            "In the request builder, input your API endpoint URL in the URL field. Click the 'Send' button to dispatch the request. Instantly see the server's response, which includes status codes, response time, and data.",
          gif: `${SendingApiRequest}`,
        },
        {
          id: 3,
          heading: "Advanced API Request with Detailed Inputs",
          subheading:
            "Enter the endpoint URL in the URL field. Utilize 'Parameters' tab for parameters, 'Body' tab to input data payloads, 'Headers' tab for custom headers, and 'Auth' tab to manage access credentials. After filling in the required fields, click 'Send' to execute the request and view the detailed server response.",
          gif: `${AdvanceAPI}`,
        },
      ]}
    />
  </div>
</Modal>

<style>
  .rest-explorer-layout {
    background-color: var(--bg-secondary-850);
  }

  :global(.rest-splitter.splitpanes--vertical .splitpanes__splitter) {
    width: 10.5px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-secondary-800) !important;
    border-right: 5px solid var(--border-secondary-800) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter.splitpanes--horizontal .splitpanes__splitter) {
    height: 10.5px !important;
    width: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-top: 5px solid var(--border-secondary-800) !important;
    border-bottom: 5px solid var(--border-secondary-800) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
      .rest-splitter .splitpanes__splitter:active,
      .rest-splitter .splitpanes__splitter:hover
    ) {
    background-color: var(--bg-primary-200) !important;
  }
  .link {
    color: var(--bg-primary-300);
    text-decoration: underline;
  }
</style>
